<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ui/ui.DataSelector.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="za.Controller.html">Controller</a></li><li><a href="za.ui.Alert.html">Alert</a><ul class='methods'><li data-type='method'><a href="za.ui.Alert.html#.dispose">dispose</a></li><li data-type='method'><a href="za.ui.Alert.html#.fade">fade</a></li><li data-type='method'><a href="za.ui.Alert.html#.spawn">spawn</a></li></ul></li><li><a href="za.ui.BubbleMenu.html">BubbleMenu</a><ul class='methods'><li data-type='method'><a href="za.ui.BubbleMenu.html#.remove">remove</a></li></ul></li><li><a href="za.ui.CenteredWindow.html">CenteredWindow</a><ul class='methods'><li data-type='method'><a href="za.ui.CenteredWindow.html#.dispose">dispose</a></li><li data-type='method'><a href="za.ui.CenteredWindow.html#.position">position</a></li><li data-type='method'><a href="za.ui.CenteredWindow.html#.spawn">spawn</a></li><li data-type='method'><a href="za.ui.CenteredWindow.html#.updateField">updateField</a></li></ul></li><li><a href="za.ui.Checkbox.html">Checkbox</a><ul class='methods'><li data-type='method'><a href="za.ui.Checkbox.html#.check">check</a></li><li data-type='method'><a href="za.ui.Checkbox.html#.isChecked">isChecked</a></li><li data-type='method'><a href="za.ui.Checkbox.html#.uncheck">uncheck</a></li></ul></li><li><a href="za.ui.Confirm.html">Confirm</a></li><li><a href="za.ui.Darkness.html">Darkness</a><ul class='methods'><li data-type='method'><a href="za.ui.Darkness.html#.fade">fade</a></li><li data-type='method'><a href="za.ui.Darkness.html#.spawn">spawn</a></li></ul></li><li><a href="za.ui.DataSelector.html">DataSelector</a><ul class='methods'><li data-type='method'><a href="za.ui.DataSelector.html#.dispose">dispose</a></li><li data-type='method'><a href="za.ui.DataSelector.html#.fade">fade</a></li><li data-type='method'><a href="za.ui.DataSelector.html#.spawn">spawn</a></li></ul></li><li><a href="za.ui.DialogButtons.html">DialogButtons</a><ul class='methods'><li data-type='method'><a href="za.ui.DialogButtons.html#.focus">focus</a></li></ul></li><li><a href="za.ui.Disposable.html">Disposable</a></li><li><a href="za.ui.Loader.html">Loader</a></li><li><a href="za.ui.Select.html">Select</a></li><li><a href="za.ui.SuperFocusable.html">SuperFocusable</a><ul class='methods'><li data-type='method'><a href="za.ui.SuperFocusable.html#.focus">focus</a></li><li data-type='method'><a href="za.ui.SuperFocusable.html#.restore">restore</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="za.ui.Alert.html#event:disposed">disposed</a></li><li><a href="za.ui.CenteredWindow.html#event:change">change</a></li><li><a href="za.ui.CenteredWindow.html#event:disposed">disposed</a></li><li><a href="za.ui.Checkbox.html#event:checked">checked</a></li><li><a href="za.ui.Checkbox.html#event:unchecked">unchecked</a></li><li><a href="za.ui.Darkness.html#event:click">click</a></li><li><a href="za.ui.DataSelector.html#event:disposed">disposed</a></li><li><a href="za.ui.DataSelector.html#event:new">new</a></li><li><a href="za.ui.DialogButtons.html#event:click">click</a></li><li><a href="za.ui.Disposable.html#event:disposed">disposed</a></li><li><a href="za.ui.Select.html#event:change">change</a></li></ul><h3>Namespaces</h3><ul><li><a href="za.html">za</a><ul class='methods'><li data-type='method'><a href="za.html#.geoRequest">geoRequest</a></li><li data-type='method'><a href="za.html#.this.logout">this.logout</a></li></ul></li><li><a href="za.controllers.html">controllers</a></li><li><a href="za.ui.html">ui</a><ul class='methods'><li data-type='method'><a href="za.ui.html#.initControllers">initControllers</a></li><li data-type='method'><a href="za.ui.html#.ntFocus">ntFocus</a></li><li data-type='method'><a href="za.ui.html#.rightColCheck">rightColCheck</a></li><li data-type='method'><a href="za.ui.html#.spawnUserBubbleMenu">spawnUserBubbleMenu</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">ui/ui.DataSelector.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Creates a {@link za.ui.CenteredWindow} with background {@link za.ui.Darkness}
 * which contains a data fetching and display mechanism and a
 * {@link za.ui.DialogButtons} set of options.
 * @class za.ui.DataSelector
 * @param {Object} options
 * @param {String} [options.title=''] Window title core text id.
 * @param {String} [options.message=''] Window message core text id.
 * @param {Boolean} [options.search=false] Boolean about whether or not data
 * options are searchable.
 * @param {String} [options.searchPlaceholder=''] Search field's placeholder
 * core text id.
 * @param {Boolean} [options.buffered=false] Boolean whether or not to query
 * for more data on scroll down if dataSource is a url.
 * @param {Boolean} [options.multiSelect=false] Boolean whether or not it is
 * possible to select multiple rows.
 * @param {String} [options.image] The key that contains an image path to
 * display on the left of the row.
 * @param {Boolean} [options.cancelable=true] Boolean about whether the window
 * can be disposed or not.
 * @param {Array|Function|String} options.dataSource Array of data or string
 * of api url to fetch them. Takes in $q if searchable and $i if multipart.
 * @param {Array} [options.selection] of objects who's key/value pairs, if
 * matched by any row, will make that row selected.
 */
za.ui.DataSelector = function(options){

   var NO_RESULTS =
      '&lt;div class="data-selector-no-results" data-html-no_results>' +
         clientData.core_text.no_results +
      '&lt;/div>';

   options = typeof options === 'object' ? options : {};
   var cancelable = 'cancelable' in options ? options.cancelable : true;

   var title = 'title' in options ? options.title : '';
   var message = 'message' in options ? options.message : '';

   title = clientData.core_text[title];
   message = clientData.core_text[message];

   var object = this;
   var darkness = new za.ui.Darkness();
   var dialogButtons = new za.ui.DialogButtons([
      { id: 'no', text: 'cancel' },
      { id: 'yes', text: 'ok' },
   ]);
   var centeredWindow = new za.ui.CenteredWindow({
      fields: 'title description search pool buttons',
      cancelable: true,
      disposable: false
   });

   var $i = 0;
   var $q = '';

   var lastCall;
   var dry;

   if(options.title)
      centeredWindow.updateField('title', title);

   if(options.message)
      centeredWindow.updateField('description', message);

   if(options.search) {
      var searchElement = $('&lt;input>');

      options.searchPlaceholder = options.searchPlaceholder || 'search';

      searchElement
         .addClass('selector-search-field')
         .attr('data-placeholder-'+options.searchPlaceholder, 1)
         .attr('placeholder', clientData.core_text[options.searchPlaceholder]);

      searchElement.keyup(function(e){
         var keycode = e.keyCode;

         (
            keycode === 8 ||
         (keycode > 47 &amp;&amp; keycode &lt; 58) ||
         (keycode > 64 &amp;&amp; keycode &lt; 91) ||
         (keycode > 95 &amp;&amp; keycode &lt; 112)
         ) &amp;&amp;
         updatePool(e);

         if(~[40].indexOf(keycode))
            pool.find('.selector-pool-row:first-child .za-checkbox').focus();

      });

      centeredWindow.updateField('search', searchElement);
   }

   function updatePool(){
      lastCall &amp;&amp; lastCall.abort();
      $q = centeredWindow.element.find('input.selector-search-field').val();
      dry = false;

      if(typeof options.dataSource === 'string') {
         pool.html('');
         lastCall =
            za
            .send(options.dataSource.replace(/\$i/, $i).replace(/\$q/, encodeURIComponent($q)))
            .success(function(response){
               if(response.data.data.length){
                  appendFromRowArray(response.data.data);
               } else {
                  dry = true;
                  pool.append(NO_RESULTS);
               }
            });
      } else if(typeof options.dataSource === 'function') {

         options.dataSource($q, $i, function(results){
            pool.html('');
            results.length ?
            appendFromRowArray(results) :
            pool.append(NO_RESULTS);
         });

      } else {

         var candidates = pool.find('.selector-pool-row .za-checkbox-text');
         var matches = 0;

         pool.find('.data-selector-no-results').remove();

         candidates.each(function(i,e){

            if(new RegExp($q, 'i').test($(e).text())) {
               matches++;
               $(e).parents('.selector-pool-row').show();
            } else
               $(e).parents('.selector-pool-row').hide();
         });

         !matches &amp;&amp;
         pool.append(NO_RESULTS);

      }
   }

   function Row(row) {
      var element = this.element = $('&lt;div>');
      var rowTitle = typeof options.rowTitle === 'function' ? options.rowTitle(row) : row[options.rowTitle];

      if(options.image)
         rowTitle = '&lt;img src="'+row[options.image]+'" style="width: 26px" />' + rowTitle;

      var checkbox =
         this.checkbox =
            new za.ui.Checkbox(rowTitle, {}, false, 'light');

      checkbox.on('focus', function(){ element.addClass('focus'); });
      checkbox.on('blur', function(){ element.removeClass('focus'); });

      checkbox.element.keydown(function(e){

         if(~[38,40].indexOf(e.keyCode)) {

            element[e.keyCode==38?'prev':'next']('.selector-pool-row')
               .find('.za-checkbox')
               .focus();

            e.preventDefault();
            e.stopPropagation();

            return false;

         }

      });

      element.click(function(e){
         $(e.target).is(':not(.za-checkbox,.za-checkbox *)') &amp;&amp;
         element.find('.za-checkbox').click();
      });

      options.selection &amp;&amp; options.selection.forEach(function(s){
         Object.keys(s).forEach(function(k){
            row[k] == s[k] &amp;&amp;
            checkbox.check();
         });
      });

      element
      .addClass('selector-pool-row')
      .html(checkbox.element);
   }

   function appendFromRowArray(array) {
      array.forEach(function(row){
         var entry = new Row(row);
         var checkbox = entry.checkbox;

         checkbox.on('checked', function(){
            if(!options.multiSelect) {
               checkbox
                  .element
                  .parents('.selector-pool-row')
                  .siblings('.selector-pool-row:has(.za-checkbox.checked)')
                  .find('.za-checkbox.checked')
                  .removeClass('checked');

               /**
                * New selection finalized.
                * @event za.ui.DataSelector#new
                */
               object.emit('new', row);
               object.dispose();
            }
         });

         pool.append(entry.element);
      });
   }

   var pool = $('&lt;div>');

   pool
      .addClass('data-selector-pool');

   centeredWindow.updateField('pool', pool);

   centeredWindow.updateField('buttons', dialogButtons.element);

   /**
    * Animates the window into existence.
    * @method za.ui.DataSelector.spawn
    * @returns {za.ui.DataSelector}
    */
   this.spawn = function(){
      darkness.spawn();
      centeredWindow.spawn();
      dialogButtons.focus('yes');
      if(searchElement)
         za.ui.ntFocus(searchElement);
      if(options.dataSource instanceof Array)
         appendFromRowArray(options.dataSource);
      else if(~['function','string'].indexOf(typeof options.dataSource))
         updatePool();
      return object;
   };

   /**
    * Smoothly fades the window out.
    * @method za.ui.DataSelector.fade
    * @returns {za.ui.DataSelector}
    */
   this.fade = function(){
      darkness.hide();
      centeredWindow.dispose();
      return object;
   };

   /**
    * Animates the window into existence.
    * @method za.ui.DataSelector.dispose
    * @emits za.ui.DataSelector#disposed
    * @returns {za.ui.DataSelector}
    */
   this.dispose = function(){
      /**
       * The window has been disposed.
       * @event za.ui.DataSelector#disposed
       */
      object.emit('disposed');
      darkness.fade();
      centeredWindow.dispose();
      return object;
   };

   if(cancelable)
      darkness.on('click', this.dispose);

   centeredWindow.on('disposed', this.dispose);
   dialogButtons.on('click', function(option){

      object.emit(option.id);
      // @todo Emit data
      object.dispose();

   });

   this.darkness = darkness;
   this.window = centeredWindow;

};

za.ui.DataSelector.prototype = EventEmitter2.prototype;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri May 20 2016 23:59:53 GMT+0300 (GTB Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
